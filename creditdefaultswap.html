{% extends "base.html" %}

{% block content %}
<h2>Credit Default Swap</h2>
<h3>Introduction</h3>

<div id="markdown-content">
    {{ md_content|safe }}
</div>

<div class="loading-spinner" id="loadingSpinner" style="display: none;">
    <div class="spinner"></div>
</div>

<h3>Credit Default Swap</h3>

<form id="cds-form" method="post" class="form-grid">
    <div class="form-group">
        <label for="nominal">Nominal ($):</label>
        <input type="number" step="0.01" id="nominal" name="nominal" value="{{ form_data.nominal }}" required>
    </div>
    <div class="form-group">
        <label for="spread">Spread (i.e., 0.05):</label>
        <input type="number" step="0.0001" id="spread" name="spread" value="{{ form_data.spread }}" required>
    </div>
    <div class="form-group">
        <label for="recovery_rate">Recovery Rate (i.e., 0.40):</label>
        <input type="number" step="0.0001" id="recovery_rate" name="recovery_rate" value="{{ form_data.recovery_rate }}" required>
    </div>
    <div class="form-group">
        <label for="risk_free">Risk-Free Rate (i.e., 0.05):</label>
        <input type="number" step="0.0001" id="risk_free" name="risk_free" value="{{ form_data.risk_free }}" required>
    </div>
    <div class="form-group">
        <label for="calendar_type">Calendar Type:</label>
        <select id="calendar_type" name="calendar_type" required>
            <option value="American" {% if form_data.calendar_type == "American" %}selected{% endif %}>American</option>
            <option value="TARGET" {% if form_data.calendar_type == "TARGET" %}selected{% endif %}>TARGET</option>
            <option value="UnitedKingdom" {% if form_data.calendar_type == "UnitedKingdom" %}selected{% endif %}>United Kingdom</option>
            <option value="China" {% if form_data.calendar_type == "China" %}selected{% endif %}>China</option>
        </select>
    </div>
    <div class="form-group">
        <label for="side_type">Side Type:</label>
        <select id="side_type" name="side_type" required>
            <option value="Seller" {% if form_data.side_type == "Seller" %}selected{% endif %}>Seller</option>
            <option value="Buyer" {% if form_data.side_type == "Buyer" %}selected{% endif %}>Buyer</option>
        </select>
    </div>
    <div class="form-group">
        <label for="selected_tenor">Selected Tenor:</label>
        <select id="selected_tenor" name="selected_tenor" required>
            <option value="Annual" {% if form_data.selected_tenor == "Annual" %}selected{% endif %}>Annual</option>
            <option value="Semiannual" {% if form_data.selected_tenor == "Semiannual" %}selected{% endif %}>Semiannual</option>
            <option value="Quarterly" {% if form_data.selected_tenor == "Quarterly" %}selected{% endif %}>Quarterly</option>
            <option value="Monthly" {% if form_data.selected_tenor == "Monthly" %}selected{% endif %}>Monthly</option>
        </select>
    </div>
    <div class="form-group">
        <label for="entry_date">Entry Date:</label>
        <input type="date" id="entry_date" name="entry_date" value="{{ form_data.entry_date }}" required>
    </div>
    <div class="form-group">
        <label for="end_date">End Date:</label>
        <input type="date" id="end_date" name="end_date" value="{{ form_data.end_date }}" required>
    </div>

    <button type="submit" class="btn btn-primary">Calculate Credit Default Swaps</button>
</form>

{% if cds_results is not none %}
<h4>Credit Default Swap Results</h4>
<table class="results-table">
    <thead>
        <tr>
            <th>Net Present Value</th>
            <th>Fair Spread</th>
            <th>Default Probability</th>
            <th>Expected Loss</th>
            <th>Premium Payment</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ cds_results['Net Present Value'] if cds_results is not none else '' }}</td>
            <td>{{ cds_results['Fair Spread'] if cds_results is not none else '' }}</td>
            <td>{{ cds_results['Default Probability'] if cds_results is not none else '' }}</td>
            <td>{{ cds_results['Expected Loss'] if cds_results is not none else '' }}</td>
            <td>{{ cds_results['Premium Payment'] if cds_results is not none else '' }}</td>
        </tr>
    </tbody>
</table>
{% endif %}

<!-- Analysis Tabs -->
<div id="analysis-section">
    <h3>Analysis</h3>
    <div class="tabs">
        <button class="tab-button" onclick="openTab(event, 'sensitivity-analysis')">Sensitivity Analysis</button>
        <button class="tab-button" onclick="openTab(event, 'scenario-analysis')">Scenario Analysis</button>
    </div>
    <div id="sensitivity-analysis" class="tab-content" style="display: block;"> <!-- Default display is block -->
        <h4>Sensitivity Analysis</h4>
        <form id="sensitivity-form" onsubmit="return false;" class="form-grid">
            <input type="hidden" name="analysis_type" value="sensitivity">
            <input type="hidden" name="nominal" value="{{ form_data.nominal }}">
            <input type="hidden" name="spread" value="{{ form_data.spread }}">
            <input type="hidden" name="recovery_rate" value="{{ form_data.recovery_rate}}">
            <input type="hidden" name="risk_free" value="{{ form_data.risk_free}}">
            <input type="hidden" name="calendar_type" value="{{ form_data.calendar_type }}">
            <input type="hidden" name="side_type" value="{{ form_data.side_type }}">
            <input type="hidden" name="selected_tenor" value="{{ form_data.selected_tenor }}">
            <input type="hidden" name="entry_date" value="{{ form_data.entry_date }}">
            <input type="hidden" name="end_date" value="{{ form_data.end_date }}">

            <div class="form-group">
                <label for="num_steps">Number of Steps (i.e., 10):</label>
                <input type="number" id="num_steps" name="num_steps" value="{{ form_data.num_steps }}" required>
            </div>
            <div class="form-group">
                <label for="range_span">Step Range (i.e., 0.01):</label>
                <input type="number" step="0.01" id="range_span" name="range_span" value="{{ form_data.range_span }}" required>
            </div>
            <div class="form-group">
                <label for="variable">Input Variable:</label>
                <select id="variable" name="variable" required>
                    <option value="risk_free" {% if form_data.variable == 'risk_free' %}selected{% endif %}>Risk Free Rate</option>
                    <option value="recovery_rate" {% if form_data.variable == 'recovery_rate' %}selected{% endif %}>Recovery Rate</option>
                    <option value="spread" {% if form_data.variable == 'spread' %}selected{% endif %}>Spread</option>
                </select>
            </div>
            <div class="form-group full-width">
                <button type="button" onclick="submitForm('sensitivity-form', '/credit-derivatives/credit_default_swap', 'sensitivity-results');">Run Sensitivity Analysis</button>
            </div>
        </form>
        <div id="sensitivity-results" class="sens-results">
            {% if cds_analysis_results %}
            <div class="result">
                <h4>Sensitivity Analysis Results</h4>
                <img src="{{ url_for('static', filename=session['cds_sensitivity_analysis_results']['plot_filename']) }}" alt="Plot">
            {% endif %}
            </div>
        </div>
    </div>
    <!-- Scenario Analysis Tab Content -->
    <div id="scenario-analysis" class="tab-content">
        <h4>Scenario Analysis</h4>
        <form id="scenario-form" onsubmit="return false;" class="form-grid">
            <input type="hidden" name="analysis_type" value="scenario">
            <input type="hidden" name="nominal" value="{{ form_data.nominal }}">
            <input type="hidden" name="spread" value="{{ form_data.spread }}">
            <input type="hidden" name="recovery_rate" value="{{ form_data.recovery_rate}}">
            <input type="hidden" name="risk_free" value="{{ form_data.risk_free}}">
            <input type="hidden" name="calendar_type" value="{{ form_data.calendar_type }}">
            <input type="hidden" name="side_type" value="{{ form_data.side_type }}">
            <input type="hidden" name="selected_tenor" value="{{ form_data.selected_tenor }}">
            <input type="hidden" name="entry_date" value="{{ form_data.entry_date }}">
            <input type="hidden" name="end_date" value="{{ form_data.end_date }}">


            <div class="form-group">
                <label for="rate_scenario">Interest Rate Scenario:</label>
                <select id="rate_scenario" name="rate_scenario" required>
                    <option value="-0.05">-5%</option>
                    <option value="-0.02">-2%</option>
                    <option value="-0.01">-1%</option>
                    <option value="0">0%</option>
                    <option value="0.01">1%</option>
                    <option value="0.02">2%</option>
                    <option value="0.05">5%</option>
                </select>
            </div>
            <div class="form-group">
                <label for="spread_scenario">Spread Scenario:</label>
                <select id="spread_scenario" name="spread_scenario" required>
                    <option value="-0.05">-5%</option>
                    <option value="-0.02">-2%</option>
                    <option value="-0.01">-1%</option>
                    <option value="0">0%</option>
                    <option value="0.01">1%</option>
                    <option value="0.02">2%</option>
                    <option value="0.05">5%</option>
                </select>
            </div>
            <div class="form-group">
                <label for="recovery_scenario">Recovery Rate Scenario:</label>
                <select id="recovery_scenario" name="recovery_scenario" required>
                    <option value="-0.25">-25%</option>
                    <option value="-0.2">-20%</option>
                    <option value="-0.1">-10%</option>
                    <option value="0">0%</option>
                    <option value="0.1">10%</option>
                    <option value="0.2">20%</option>
                    <option value="0.25">25%</option>
                </select>
            </div>
            <div class="form-group full-width">
                <button type="button" onclick="submitForm('scenario-form', '/credit-derivatives/credit_default_swap', 'scenario-results');">Run Scenario Analysis</button>
            </div>
        </form>
        <!-- Scenario Analysis Results -->
        <div id="scenario-results" class="sens-results">
            {% if baseline_EL is not none or stressed_EL is not none %}
            <h4>Scenario Analysis Results</h4>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Scenarios</th>
                        <th>Net Present Value</th>
                        <th>Fair Spread</th>
                        <th>Default Probability</th>
                        <th>Expected Loss</th>
                        <th>Premium Payment</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Baseline</td>
                        <td>{{ baseline_EL['Net Present Value'] if baseline_EL is not none else '' }}</td>
                        <td>{{ baseline_EL['Fair Spread'] if baseline_EL is not none else '' }}</td>
                        <td>{{ baseline_EL['Default Probability'] if baseline_EL is not none else '' }}</td>
                        <td>{{ baseline_EL['Expected Loss'] if baseline_EL is not none else '' }}</td>
                        <td>{{ baseline_EL['Premium Payment'] if baseline_EL is not none else '' }}</td>
                    </tr>
                    <tr>
                        <td>Stressed</td>
                        <td>{{ stressed_EL['Net Present Value'] if stressed_EL is not none else '' }}</td>
                        <td>{{ stressed_EL['Fair Spread'] if stressed_EL is not none else '' }}</td>
                        <td>{{ stressed_EL['Default Probability'] if stressed_EL is not none else '' }}</td>
                        <td>{{ stressed_EL['Expected Loss'] if stressed_EL is not none else '' }}</td>
                        <td>{{ stressed_EL['Premium Payment'] if stressed_EL is not none else '' }}</td>
                    </tr>
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
</div>


<!-- JavaScript for Form Submission and Loading Spinner -->
<script>
document.getElementById('options-form').addEventListener('submit', function(event) {
    var loadingSpinner = document.getElementById('loadingSpinner');
    loadingSpinner.style.display = 'block';  // Show spinner on form submit

    window.addEventListener('load', function() {
        loadingSpinner.style.display = 'none';  // Hide spinner on page load
    });
});

// JavaScript for AJAX Form Submission
function submitForm(formId, url, updateId) {
    var form = document.getElementById(formId);
    var formData = new FormData(form);
    var xhr = new XMLHttpRequest();

    xhr.open("POST", url, true);

    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            console.log("Form submitted successfully");
            var parser = new DOMParser();
            var doc = parser.parseFromString(xhr.responseText, 'text/html');

            // Update the relevant section
            var updateSection = doc.getElementById(updateId);
            if (updateSection) {
                document.getElementById(updateId).innerHTML = updateSection.innerHTML;
                // Show the results section after successfully updating it
                document.getElementById(updateId).style.display = 'block';
            } else {
                console.log("Update section not found");
            }
        } else if (xhr.readyState === 4) {
            console.log("Error in form submission: " + xhr.status);
        }
    };

    xhr.onerror = function() {
        console.log("Request failed");
    };

    xhr.send(formData);
}

// JavaScript for Tabs
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;

    // Hide all tab contents
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Remove the active class from all tab buttons
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab content and add an active class to the button that opened the tab
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

// By default, open the first tab
document.addEventListener("DOMContentLoaded", function() {
    document.querySelector(".tab-button").click();
});
</script>


{% endblock %}
