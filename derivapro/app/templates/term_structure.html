{% extends "base.html" %}

{% block content %}
<h2>Term Structure</h2>
<h3>Introduction</h3>

<div id="markdown-content">
  {{ md_content|safe }}
</div>

<div class="loading-spinner" id="loadingSpinner" style="display: none;">
  <div class="spinner"></div>
</div>


<h3>Term Structure Calculator</h1>

<form id="term-structure-form" method="post" class="form-grid">
<!--action="{{ url_for('term_structure.calculate_term_structure') }}" -->
    <div class = form-group>
      <label for="start_date">Start Date (YYYY-MM-DD):</label>
      <input type="date" id="start_date" name="start_date" value="{{ form_data.start_date }}" required>
    </div>

    <div class = form-group>
      <label for="forward_tenor"> Forward Tenor:</label>
      <select id="forward_tenor_str" name="forward_tenor_str">
        <option value="1M" {% if form_data.forward_tenor_str == '1M' %}selected{% endif %}>1M</option>
        <option value="3M" {% if form_data.forward_tenor_str == '3M' %}selected{% endif %}>3M</option>
        <option value="6M" {% if form_data.forward_tenor_str == '6M' %}selected{% endif %}>6M</option>
      </select>
    </div>

    <div class = form-group>
      <label for="method_name">Method Name:</label>
      <select id="method_name" name="method_name">
        <option value="PiecewiseFlatForward" {% if form_data.method_name == 'PiecewiseFlatForward' %}selected{% endif %}>PiecewiseFlatFoward</option>
        <option value="LogLinearDiscount" {% if form_data.method_name == 'LogLinearDiscount' %}selected{% endif %}>LogLinearDiscount</option>
        <option value="LogCubicDiscount" {% if form_data.method_name == 'LogCubicDiscount' %}selected{% endif %}>LogCubicDiscount</option>
        <option value="LinearZero" {% if form_data.method_name == 'LinearZero' %}selected{% endif %}>LinearZero</option>
        <option value="CubicZero" {% if form_data.method_name == 'CubicZero' %}selected{% endif %}>CubicZero</option>
        <option value="LinearForward" {% if form_data.method_name == 'LinearForward' %}selected{% endif %}>LinearForward</option>
        <option value="SplineCubicDiscount" {% if form_data.method_name == 'SplineCubicDiscount' %}selected{% endif %}>SplineCubicDiscount</option>
      </select>
    </div>
    
    <div class = form-group>
      <label for="fit_selection">Fit Selection:</label>
      <select id="fit_selection" name="fit_selection">
        <option value="Yes" {% if form_data.fit_selection == 'Yes' %}selected{% endif %}>Yes</option>
        <option value="No" {% if form_data.fit_selection == 'No' %}selected{% endif %}>No</option>
      </select>
    </div>

    <div class="form-group full-width">
      <button type="submit">Calculate Term Structure</button>
    </div>
</form>

<!-- 
  <label for="start_date">Start Date (dd-mm-yyyy):</label>
  <input type="text" id="start_date" name="start_date" value="{{ start_date or '24-02-2016' }}" required />

  <label for="method_name">Method Name:</label>
  <select id="method_name" name="method_name">
    {% for method in ['PiecewiseFlatForward', 'LogLinearDiscount', 'LogCubicDiscount', 'LinearZero', 'CubicZero', 'LinearForward', 'SplineCubicDiscount'] %}
      <option value="{{ method }}" {% if method == method_name %}selected{% endif %}>{{ method }}</option>
    {% endfor %}
  </select>

    <label for="fit_selection">Fit Selection:</label>
  <select id="fit_selection" name="fit_selection">
    {% for val in ['yes', 'no'] %}
      <option value="{{ val }}" {% if val == fit_selection %}selected{% endif %}>{{ val|capitalize }}</option>
    {% endfor %}
  </select>

    <button type="submit">Calculate Term Structure</button>

{% if error %}
  <p style="color:red;">Error: {{ error }}</p>
{% endif %}

    -->

{% if plot %}
  {% if form_data.fit_selection == 'Yes' %}
    <h2>Fit Quality (R² Values)</h2>
    <table border="1" cellpadding="5">
      <thead>
        <tr>
          <th>Model</th>
          <th>Zero Rates R²</th>
          <th>Discount Factors R²</th>
          <th>Forward Rates R²</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Nelson-Siegel</td>
          <td>{{ r2_ns_zero | round(4) }}</td>
          <td>{{ r2_ns_df | round(4) }}</td>
          <td>{{ r2_ns_fwd | round(4) }}</td>
        </tr>
        <tr>
          <td>Svensson</td>
          <td>{{ r2_sv_zero | round(4) }}</td>
          <td>{{ r2_sv_df | round(4) }}</td>
          <td>{{ r2_sv_fwd | round(4) }}</td>
        </tr>
      </tbody>
    </table>
  {% endif %}

  {% if session.yield_curve_plot %}
    <h2>Yield Curve Plots</h2>
    <img src="{{ url_for('static', filename='plots/' + session.yield_curve_plot.filename) }}" alt="Yield Curve Plot" />
  {% endif %}
  
  {% if session.yield_curve_plot %}
    <div id="Analysis">
      <h2>Analysis</h2>
      <div class="tabs">
          <button class="tab-button" onclick="openTab(event, 'parallel-shock-generator')">Parallel Shock Generator</button>
          <button class="tab-button" onclick="openTab(event, 'non-parallel-shock-generator')">Non-Parallel Shock Generator</button>
      </div>

      <div id="parallel-shock-generator" class="tab-content">
        <h3>Parallel Shocks</h3>
        <form id="parallel-shock-form" onsubmit="return false;" class="form-grid">
            <input type="hidden" name="analysis_type" value="parallel">
            <input type="hidden" name="start_date" value="{{ form_data.start_date }}">
            <input type="hidden" name="forward_tenor_str" value="{{ form_data.forward_tenor_str or '3M' }}">
            <input type="hidden" name="method_name" value="{{ form_data.method_name }}">
            <input type="hidden" name="fit_selection" value="{{ form_data.fit_selection }}">
            <div class="form-group full-width">
              <label for="parallelShockValue"> Parallel Shock Value (bps):</label>
              <select id="parallelShockValue" name="parallelShockValue">
                <option value="">--Select Value--</option>
                <option value="+300">+300</option>
                <option value="+250">+250</option>
                <option value="+200">+200</option>
                <option value="+150">+150</option>
                <option value="+100">+100</option>
                <option value="+50">+50</option>
                <option value="-50">-50</option>
                <option value="-100">-100</option>
                <option value="-150">-150</option>
                <option value="-200">-200</option>
                <option value="-250">-250</option>
                <option value="-300">-300</option>
              </select>
            </div>

            <div class="form-group full-width">
                <button type="button" onclick="submitForm('parallel-shock-form', '/term-structure/calculate-term-structure', 'parallel-shock-results');">Shock Curve</button>
                <p> After clicking "Shock Curve", please wait a moment for the graphs to appear below </p>
              </div>
        </form>

        <div id="parallel-shock-results" class="result">
          {% if session.shocked_yield_curve_plot_filename %}
          {% if form_data.fit_selection == 'Yes' %}
            <h2>Shocked Fit Quality (R² Values)</h2>
            <table border="1" cellpadding="5">
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Zero Rates R²</th>
                  <th>Discount Factors R²</th>
                  <th>Forward Rates R²</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Nelson-Siegel</td>
                  <td>{{ r2_ns_zero | round(4) }}</td>
                  <td>{{ r2_ns_df | round(4) }}</td>
                  <td>{{ r2_ns_fwd | round(4) }}</td>
                </tr>
                <tr>
                  <td>Svensson</td>
                  <td>{{ r2_sv_zero | round(4) }}</td>
                  <td>{{ r2_sv_df | round(4) }}</td>
                  <td>{{ r2_sv_fwd | round(4) }}</td>
                </tr>
              </tbody>
            </table>
          {% endif %}

          <h2>Shocked Yield Curve Plots</h2>
            <img src="{{ url_for('static', filename='plots/' + session.shocked_yield_curve_plot_filename) }}" alt="Shocked Yield Curve Plot" />
          {% endif %}
        </div>
      </div>

      <div id="non-parallel-shock-generator" class="tab-content">
        <h3>Non-Parallel Shocks</h3>
        <form id="non-parallel-shock-form" onsubmit="return false;" class="form-grid">
            <input type="hidden" name="analysis_type" value="non-parallel">
            <input type="hidden" name="start_date" value="{{ form_data.start_date }}">
            <input type="hidden" name="forward_tenor_str" value="{{ form_data.forward_tenor_str or '3M' }}">
            <input type="hidden" name="method_name" value="{{ form_data.method_name }}">
            <input type="hidden" name="fit_selection" value="{{ form_data.fit_selection }}">

            <div class="form-group full-width">
              <label for="nonParallelShockValue"> Non-Parallel Shock:</label>
              <select id="nonParallelShockValue" name="nonParallelShockValue">
                <option value="">--Select Value--</option>
                <option value="Steepener">Steepener</option>
                <option value="Flattener">Flattener</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="nonParallelAbsoluteShock">Non-Parallel Absolute Shock Value (bps):</label>
              <select id = "nonParallelAbsoluteShock" name="nonParallelAbsoluteShock">
                <option value = "0">--Select Value--</option>
                <option value ="100">100</option>
                <option value ="200">200</option>
                <option value ="300">300</option>
              </select>
            </div>

            <div class="form-group full-width">
                <button type="button" onclick="submitForm('non-parallel-shock-form', '/term-structure/calculate-term-structure', 'non-parallel-shock-results');">Shock Curve</button>
                <p> After clicking "Shock Curve", please wait a moment for the graphs to appear below </p>
            </div>
        </form>

        <div id="non-parallel-shock-results" class="result">
          {% if session.shocked_yield_curve_plot_filename %}
            {% if form_data.fit_selection == 'Yes' %}
            <h2>Shocked Fit Quality (R² Values)</h2>
            <table border="1" cellpadding="5">
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Zero Rates R²</th>
                  <th>Discount Factors R²</th>
                  <th>Forward Rates R²</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Nelson-Siegel</td>
                  <td>{{ r2_ns_zero | round(4) }}</td>
                  <td>{{ r2_ns_df | round(4) }}</td>
                  <td>{{ r2_ns_fwd | round(4) }}</td>
                </tr>
                <tr>
                  <td>Svensson</td>
                  <td>{{ r2_sv_zero | round(4) }}</td>
                  <td>{{ r2_sv_df | round(4) }}</td>
                  <td>{{ r2_sv_fwd | round(4) }}</td>
                </tr>
              </tbody>
            </table>
            {% endif %}
          <h2>Shocked Yield Curve Plots</h2>
            <img src="{{ url_for('static', filename='plots/' + session.shocked_yield_curve_plot_filename) }}" alt="Shocked Yield Curve Plot" />
          {% endif %}
        </div>
      </div>

    </div>
  
  {% endif %}

{% endif %}

<!-- JavaScript for Form Submission and Loading Spinner -->

<script>
  document.getElementById('term-structure-form').addEventListener('submit', function(event) {
      var loadingSpinner = document.getElementById('loadingSpinner');
      loadingSpinner.style.display = 'block';  // Show spinner on form submit
  
      window.addEventListener('load', function() {
          loadingSpinner.style.display = 'none';  // Hide spinner on page load
      });
  });
  
  // JavaScript for AJAX Form Submission
  function submitForm(formId, url, updateId) {
      var form = document.getElementById(formId);
      var formData = new FormData(form);
      var xhr = new XMLHttpRequest();
  
      xhr.open("POST", url, true);
  
      xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
              // console.log("Form submitted successfully");
              console.log('Form submitted successfully')
              var parser = new DOMParser();
              var doc = parser.parseFromString(xhr.responseText, 'text/html');
  
              // Update the relevant section
              var updateSection = doc.getElementById(updateId);
              if (updateSection) {
                  document.getElementById(updateId).innerHTML = updateSection.innerHTML;
                  // Show the results section after successfully updating it
                  document.getElementById(updateId).style.display = 'block';
              } else {
                  console.log("Update section not found");
              }
          } else if (xhr.readyState === 4) {
              console.log("Error in form submission: " + xhr.status);
          }
      };
  
      xhr.onerror = function() {
          console.log("Request failed");
      };
  
      xhr.send(formData);
  }
  
  // JavaScript for Tabs
  function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
  
      // Hide all tab contents
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
      }
  
      //Hide the results of parallel tab
      const parallelShockResultsSection = document.getElementById('parallel-shock-results');
      parallelShockResultsSection.style.display = "none";

      //Hide the results of non parallel tab
      const nonParallelShockResultsSection = document.getElementById('non-parallel-shock-results');
      nonParallelShockResultsSection.style.display = "none";

      // Remove the active class from all tab buttons
      tablinks = document.getElementsByClassName("tab-button");
      for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
  
      // Show the current tab content and add an active class to the button that opened the tab
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
  }
  
  // By default, open the first tab
  document.addEventListener("DOMContentLoaded", function() {
      document.querySelector(".tab-button").click();
  });
  </script>

{% endblock %}