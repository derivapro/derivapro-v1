{% extends "base.html" %}

{% block content %}
<!-- Go Back Button at the Top -->
<div class="form-group full-width">
    <button type="button" onclick="goBackWithResults();" class="btn btn-primary nav-btn">Go Back</button>
</div>

<h2>Ongoing Monitoring</h2>

<!-- Display the markdown content -->
<div id="markdown-content">
    {{ md_content|safe }}
</div>

<!-- AI Assessment Section -->
<div class="form-group full-width">
    <button type="button" onclick="runAIAssessment();" class="btn btn-primary nav-btn">AI Assessment</button>
</div>

<div id="ai-assessment-section" class="gpt-results" style="display: none;">
    <textarea id="gpt-assessment" readonly></textarea>
    <button type="button" id="edit-assessment-btn" onclick="editAssessment();" class="btn btn-secondary">Edit</button>
    <button type="button" id="save-assessment-btn" onclick="saveAssessment();" class="btn btn-primary" style="display: none;">Save</button>
</div>

<script>
function goBackWithResults() {
    const params = new URLSearchParams({
        ticker: "{{ session.get('form_data', {}).get('ticker', '') }}",
        strike_price: "{{ session.get('form_data', {}).get('strike_price', '') }}",
        start_date: "{{ session.get('form_data', {}).get('start_date', '') }}",
        end_date: "{{ session.get('form_data', {}).get('end_date', '') }}",
        risk_free_rate: "{{ session.get('form_data', {}).get('risk_free_rate', '') }}",
        volatility: "{{ session.get('form_data', {}).get('volatility', '') }}",
        option_type: "{{ session.get('form_data', {}).get('option_type', '') }}",
        model_type: "{{ session.get('form_data', {}).get('model_type', '') }}",
        option_price: "{{ session.get('option_price', '') }}",
        delta: "{{ session.get('delta', '') }}",
        gamma: "{{ session.get('gamma', '') }}",
        vega: "{{ session.get('vega', '') }}",
        theta: "{{ session.get('theta', '') }}",
        rho: "{{ session.get('rho', '') }}"
    });

    window.location.href = "{{ url_for('vanilla_options.european_options') }}" + "?" + params.toString();
}


function runAIAssessment() {
    fetch('/vanilla-options/ai-assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: 'Please assess the reasonableness and comprehensiveness of the ongoing monitoring for vanilla option model as shown in ongoing_monitoring.md.' })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('gpt-assessment').value = data.assessment;
        document.getElementById('ai-assessment-section').style.display = 'block';
    });
}

function editAssessment() {
    document.getElementById('gpt-assessment').removeAttribute('readonly');
    document.getElementById('edit-assessment-btn').style.display = 'none';
    document.getElementById('save-assessment-btn').style.display = 'inline';
}

function saveAssessment() {
    const updatedAssessment = document.getElementById('gpt-assessment').value;
    fetch('/vanilla-options/save-assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assessment: updatedAssessment }),
    }).then(response => {
        if (response.ok) {
            alert('Assessment saved successfully!');
            document.getElementById('gpt-assessment').setAttribute('readonly', 'readonly');
            document.getElementById('edit-assessment-btn').style.display = 'inline';
            document.getElementById('save-assessment-btn').style.display = 'none';
        } else {
            alert('Failed to save assessment.');
        }
    });
}
</script>

{% endblock %}
