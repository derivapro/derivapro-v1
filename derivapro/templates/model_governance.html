{% extends "base.html" %}

{% block content %}
<h2>Model Governance</h2>

<!-- Go Back Button -->
<div class="form-group full-width">
    <button type="button" onclick="goBackWithResults();" class="btn btn-primary nav-btn">Go Back</button>
</div>

<!-- Display Markdown Content -->
<div id="markdown-content">
    {{ md_content|safe }}
</div>

<!-- AI Assessment Button -->
<div class="form-group full-width">
    <button type="button" onclick="runAiAssessment();" class="btn btn-primary nav-btn">AI Assessment</button>
</div>

<!-- Display AI Assessment -->
<div id="ai-assessment-section" class="gpt-results">
    {% if gpt_assessment %}
    <h4>MRM Assessment:</h4>
    <textarea id="gpt-assessment" class="assessment-box" readonly>{{ gpt_assessment }}</textarea>
    <div class="form-group">
        <button type="button" id="edit-assessment-btn" class="btn btn-primary" onclick="editAssessment();">Edit</button>
        <button type="button" id="save-assessment-btn" class="btn btn-primary" onclick="saveAssessment();" style="display: none;">Save</button>
    </div>
    {% endif %}
</div>

<script>
// Function to handle going back with form data preserved
function goBackWithResults() {
    const params = new URLSearchParams({
        ticker: "{{ session.get('form_data', {}).get('ticker', '') }}",
        strike_price: "{{ session.get('form_data', {}).get('strike_price', '') }}",
        start_date: "{{ session.get('form_data', {}).get('start_date', '') }}",
        end_date: "{{ session.get('form_data', {}).get('end_date', '') }}",
        risk_free_rate: "{{ session.get('form_data', {}).get('risk_free_rate', '') }}",
        volatility: "{{ session.get('form_data', {}).get('volatility', '') }}",
        option_type: "{{ session.get('form_data', {}).get('option_type', '') }}",
        model_type: "{{ session.get('form_data', {}).get('model_type', '') }}",
        option_price: "{{ session.get('option_price', '') }}",
        delta: "{{ session.get('delta', '') }}",
        gamma: "{{ session.get('gamma', '') }}",
        vega: "{{ session.get('vega', '') }}",
        theta: "{{ session.get('theta', '') }}",
        rho: "{{ session.get('rho', '') }}"
    });

    window.location.href = "{{ url_for('vanilla_options.european_options') }}" + "?" + params.toString();
}

// Function to handle AI Assessment
function runAiAssessment() {
    const params = new URLSearchParams({
        analysis_type: 'ai_assessment',
    });

    fetch("{{ url_for('vanilla_options.model_governance') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
    })
    .then(response => response.text())
    .then(data => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(data, 'text/html');
        const assessmentSection = doc.getElementById('ai-assessment-section');
        document.getElementById('ai-assessment-section').innerHTML = assessmentSection.innerHTML;
    })
    .catch(error => console.error('Error:', error));
}

// JavaScript for Edit and Save buttons
function editAssessment() {
    const assessmentTextarea = document.getElementById('gpt-assessment');
    assessmentTextarea.removeAttribute('readonly');
    assessmentTextarea.style.border = '2px solid #007bff';
    document.getElementById('edit-assessment-btn').style.display = 'none';
    document.getElementById('save-assessment-btn').style.display = 'inline';
}

function saveAssessment() {
    const assessmentTextarea = document.getElementById('gpt-assessment');
    assessmentTextarea.setAttribute('readonly', 'readonly');
    assessmentTextarea.style.border = '1px solid #ccc';
    document.getElementById('edit-assessment-btn').style.display = 'inline';
    document.getElementById('save-assessment-btn').style.display = 'none';
    const updatedAssessment = assessmentTextarea.value;
    
    fetch('/vanilla-options/save-assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assessment: updatedAssessment }),
    }).then(response => {
        if (response.ok) {
            alert('Assessment saved successfully!');
        } else {
            alert('Failed to save assessment.');
        }
    });
}
</script>

{% endblock %}
