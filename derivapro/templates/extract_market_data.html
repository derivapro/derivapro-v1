{% extends "base.html" %}
{% block content %}

<h2>Market Data</h2>

<!-- Markdown Readme -->
<div id="markdown-content">
    {{ md_content|safe }}
</div>

<!-- --- Treasury Rates --- -->
<h3>Treasury Rates</h3>
<form method="POST" action="{{ url_for('extract_market_data.extract_market_data') }}">
    <div class="form-group">
        <label for="treasury_start_date">As of Date:</label>
        <input type="date" id="treasury_start_date" name="treasury_start_date" 
               value="{{ treasury_form_data.start_date if treasury_form_data.start_date else '' }}" required>
    </div>

    <div class="form-group">
        <label>Select Term:</label>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
            {% for tenor in treasury_available_tenors %}
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="treasury_selected_tenors" value="{{ tenor }}"
                       {% if treasury_form_data.selected_tenors and tenor in treasury_form_data.selected_tenors %}checked{% endif %}>
                <span style="margin-left: 5px;">{{ tenor }}</span>
            </label>
            {% endfor %}
        </div>

        <!-- Select/Deselect buttons -->
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button type="button" class="btn" onclick="selectAllTenors('treasury')">Select All</button>
            <button type="button" class="btn" onclick="deselectAllTenors('treasury')">Deselect All</button>
        </div>
    </div>

    <button type="submit" name="treasury_submit" class="btn" style="margin-top: 10px;">Extract Treasury Rates</button>
</form>

{% if treasury_rates %}
<div style="margin-top: 20px;">
    <h4>Market Rates:</h4>
    <table border="1" style="border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr>
                <th style="padding: 8px;">Term</th>
                <th style="padding: 8px;">Rate (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for period, rate in treasury_rates %}
            <tr>
                <td style="padding: 8px;">{{ period }}</td>
                <td style="padding: 8px;">{{ "%.4f"|format(rate * 100) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<hr style="margin: 30px 0;">

<!-- --- SOFR Rates --- -->
<h3>SOFR Rates</h3>
<form method="POST" action="{{ url_for('extract_market_data.extract_market_data') }}">
    <div class="form-group">
        <label for="sofr_start_date">As of Date:</label>
        <input type="date" id="sofr_start_date" name="sofr_start_date" 
               value="{{ sofr_form_data.start_date if sofr_form_data.start_date else '' }}" required>
    </div>

    <!-- Separate button for Spot Rate -->
    <div class="form-group">
        <button type="submit" name="spot_rate_submit" class="btn" style="margin-top: 10px; margin-bottom: 20px;">
            Get Spot (Overnight) Rate
        </button>
    </div>

    <div class="form-group">
        <label>Select Term:</label>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
            {% for tenor in sofr_available_tenors %}
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="sofr_selected_tenors" value="{{ tenor }}"
                       {% if sofr_form_data.selected_tenors and tenor in sofr_form_data.selected_tenors %}checked{% endif %}>
                <span style="margin-left: 5px;">{{ tenor }}</span>
            </label>
            {% endfor %}
        </div>

        <!-- Select/Deselect buttons -->
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button type="button" class="btn" onclick="selectAllTenors('sofr')">Select All</button>
            <button type="button" class="btn" onclick="deselectAllTenors('sofr')">Deselect All</button>
        </div>
    </div>

    <div class="form-group">
        <label>Compounding Method:</label>
        <select name="compounding_method">
            {% for method in compounding_methods %}
            <option value="{{ method }}" {% if sofr_form_data.compounding_method == method %}selected{% endif %}>
                {{ method }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Compounding Frequency:</label>
        <select name="compounding_frequency">
            {% for freq in compounding_frequencies %}
            <option value="{{ freq }}" {% if sofr_form_data.compounding_frequency == freq %}selected{% endif %}>
                {{ freq }}
            </option>
            {% endfor %}
        </select>
    </div>

    <button type="submit" name="sofr_submit" class="btn" style="margin-top: 10px;">Calculate Compounded SOFR Rates</button>
</form>

<!-- Display Spot Rate separately -->
{% if sofr_spot_rate %}
<div style="margin-top: 20px;">
    <h4>SOFR Spot (Overnight) Rate:</h4>
    <table border="1" style="border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr>
                <th style="padding: 8px;">Date</th>
                <th style="padding: 8px;">Rate (%)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="padding: 8px;">{{ sofr_form_data.start_date if sofr_form_data.start_date else 'N/A' }}</td>
                <td style="padding: 8px;">
                    {% if sofr_spot_rate is string %}
                        {{ sofr_spot_rate }}
                    {% else %}
                        {{ "%.4f"|format(sofr_spot_rate * 100) }}
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endif %}

{% if sofr_rates_compounded %}
<div style="margin-top: 20px;">
    <h4>Compounded SOFR Rates:</h4>
    <table border="1" style="border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr>
                <th style="padding: 8px;">Term</th>
                <th style="padding: 8px;">Rate (%)</th>
            </tr>
        </thead>
        <tbody>
            {% for tenor, rate in sofr_rates_compounded %}
            <tr>
                <td style="padding: 8px;">{{ tenor }}</td>
                <td style="padding: 8px;">
                    {% if rate is string %}
                        {{ rate }}
                    {% else %}
                        {{ "%.4f"|format(rate * 100) }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function selectAllTenors(formType) {
    document.querySelectorAll(`input[name='${formType}_selected_tenors']`).forEach(cb => cb.checked = true);
}

function deselectAllTenors(formType) {
    document.querySelectorAll(`input[name='${formType}_selected_tenors']`).forEach(cb => cb.checked = false);
}
</script>

<style>
.btn {
    background-color: #0056b3;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 14px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.btn:hover {
    background-color: #003d80;
}
.btn {
    min-width: 140px;
    text-align: center;
}
</style>

{% endblock %}
