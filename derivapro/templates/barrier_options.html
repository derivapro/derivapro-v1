{% extends "base.html" %}

{% block content %}
<h2>Barrier Options</h2>
<h3>Introduction</h3>

<div id="markdown-content">
    {{ md_content|safe }}
</div>

<div class="loading-spinner" id="loadingSpinner" style="display: none;">
    <div class="spinner"></div>
</div>

<h3>Option Pricing</h3>

<form id="options-form" method="post" class="form-grid">
    <div class="form-group">
        <label for="ticker">Stock Ticker:</label>
        <input type="text" id="ticker" name="ticker" value="{{ form_data.ticker }}" required>
    </div>

    <div class="form-group">
        <label for="K">Strike Price (K):</label>
        <input type="number" step="0.01" id="K" name="K" value="{{ form_data.K }}" required>
    </div>

    <div class="form-group">
        <label for="r">Risk-Free Rate (r):</label>
        <input type="number" step="0.001" id="r" name="r" value="{{ form_data.r }}" required>
    </div>

    <div class="form-group">
        <label for="sigma">Volatility (sigma):</label>
        <input type="number" step="0.001" id="sigma" name="sigma" value="{{ form_data.sigma }}" required>
    </div>

    <div class="form-group">
        <label for="start_date">Start Date (YYYY-MM-DD):</label>
        <input type="date" id="start_date" name="start_date" value="{{ form_data.start_date }}" required>
    </div>
    
    <div class="form-group">
        <label for="end_date">End Date (YYYY-MM-DD):</label>
        <input type="date" id="end_date" name="end_date" value="{{ form_data.end_date }}" required>
    </div>

    <div class="form-group">
        <label for="q">Dividend Yield (q):</label>
        <input type="number" step="0.001" id="q" name="q" value="{{ form_data.q }}" required>
    </div>

    <div class="form-group">
        <label for="N">Number of Time Steps (N):</label>
        <input type="number" id="N" name="N" value="{{ form_data.N }}" required>
    </div>

    <div class="form-group">
        <label for="M">Number of Simulations (M):</label>
        <input type="number" id="M" name="M" value="{{ form_data.M }}" required>
    </div>

    <div class="form-group">
        <label for="barrier">Barrier Level:</label>
        <input type="number" step="0.01" id="barrier" name="barrier" value="{{ form_data.barrier }}" required>
    </div>

    <div class="form-group">
        <label for="option_type">Option Type:</label>
        <select id="option_type" name="option_type" required>
            <option value="call" {% if form_data.option_type == 'call' %}selected{% endif %}>Call</option>
            <option value="put" {% if form_data.option_type == 'put' %}selected{% endif %}>Put</option>
        </select>
    </div>

    <div class="form-group">
        <label for="barrier_type">Barrier Type:</label>
        <select id="barrier_type" name="barrier_type" required>
            <option value="up_and_out" {% if form_data.barrier_type == 'up_and_out' %}selected{% endif %}>Up-and-Out</option>
            <option value="down_and_out" {% if form_data.barrier_type == 'down_and_out' %}selected{% endif %}>Down-and-Out</option>
        </select>
    </div>

    <div class="form-group">
        <label for="simulation_engine">Simulation Engine:</label>
        <select id="simulation_engine" name="simulation_engine" required>
            <option value="original" {% if form_data.simulation_engine == 'original' %}selected{% endif %}>Original</option>
            <option value="new_MC" {% if form_data.simulation_engine == 'new_MC' %}selected{% endif %}>New MC</option>
        </select>
    </div>

    <div class="form-group">
        <label for="discretization">Discretization Method:</label>
        <select id="discretization" name="discretization" required>
            <option value="euler" {% if form_data.discretization == 'euler' %}selected{% endif %}>Euler</option>
            <option value="milstein" {% if form_data.discretization == 'milstein' %}selected{% endif %}>Milstein</option>
        </select>
    </div>

    <div class="form-group full-width">
        <button type="submit">Calculate Barrier Option Price</button>
    </div>
</form>

{% if option_price is not none %}
<div class="result">
    <h2>Barrier Option Price: {{ option_price }}</h2>
</div>
{% endif %}

<!-- Analysis Tabs -->
<div id="analysis-section">
    <h3>Analysis</h3>
    <div class="tabs">
        <button class="tab-button" onclick="openTab(event, 'sensitivity-analysis')">Sensitivity Analysis</button>
        <button class="tab-button" onclick="openTab(event, 'scenario-analysis')">Scenario Analysis</button>
        <button class="tab-button" onclick="openTab(event, 'convergence-analysis')">Convergence Analysis</button>
        <button class="tab-button" onclick="openTab(event, 'rbpl-analysis')">RBPL Analysis</button>
    </div>
    
    <div id="sensitivity-analysis" class="tab-content">
        <h4>Sensitivity Analysis</h4>
        <form id="sensitivity-form" onsubmit="return false;" class="form-grid">
            <input type="hidden" name="analysis_type" value="sensitivity">
            <input type="hidden" name="ticker" value="{{ form_data.ticker }}">
            <input type="hidden" name="K" value="{{ form_data.K }}">
            <input type="hidden" name="r" value="{{ form_data.r }}">
            <input type="hidden" name="sigma" value="{{ form_data.sigma }}">
            <input type="hidden" name="option_type" value="{{ form_data.option_type }}">
            <input type="hidden" name="start_date" value="{{ form_data.start_date }}">
            <input type="hidden" name="end_date" value="{{ form_data.end_date }}">
            <input type="hidden" name="q" value="{{ form_data.q }}">
            <input type="hidden" name="N" value="{{ form_data.N }}">
            <input type="hidden" name="M" value="{{ form_data.M }}">
            <input type="hidden" name="barrier" value="{{ form_data.barrier }}">
            <input type="hidden" name="barrier_type" value="{{ form_data.barrier_type }}">
            <input type="hidden" name="discretization" value="{{ form_data.discretization }}">
            <div class="form-group">
                <label for="num_sensitivity_steps">Number of Steps:</label>
                <input type="number" id="num_sensitivity_steps" name="num_sensitivity_steps" value="{{ form_data.num_steps }}" required>
            </div>
            <div class="form-group">
                <label for="step_range">Step Range:</label>
                <input type="number" step="0.01" id="step_range" name="step_range" value="{{ form_data.step_range }}" required>
            </div>
            <div class="form-group">
                <label for="variable">Input Variable:</label>
                <select id="variable" name="variable" required>
                    <option value="strike_price" {% if form_data.variable == 'strike_price' %}selected{% endif %}>Strike Price</option>
                    <option value="risk_free_rate" {% if form_data.variable == 'risk_free_rate' %}selected{% endif %}>Risk Free Rate</option>
                    <option value="volatility" {% if form_data.variable == 'volatility' %}selected{% endif %}>Volatility</option>
                </select>
            </div>
            <div class="form-group">
                <label for="target_variable">Target Variable:</label>
                <select id="target_variable" name="target_variable" required>
                    <option value="option_price" {% if form_data.target_variable == 'option_price' %}selected{% endif %}>Option Price</option>
                    <option value="delta" {% if form_data.target_variable == 'delta' %}selected{% endif %}>Delta</option>
                    <option value="gamma" {% if form_data.target_variable == 'gamma' %}selected{% endif %}>Gamma</option>
                    <option value="vega" {% if form_data.target_variable == 'vega' %}selected{% endif %}>Vega</option>
                    <option value="theta" {% if form_data.target_variable == 'theta' %}selected{% endif %}>Theta</option>
                    <option value="rho" {% if form_data.target_variable == 'rho' %}selected{% endif %}>Rho</option>
                </select>
            </div>
            <div class="form-group full-width">
                <button type="button" onclick="submitForm('sensitivity-form', '/exotic-options/barrier', 'sensitivity-results');">Run Sensitivity Analysis</button>
            </div>
        </form>
    </div>
    <div id="sensitivity-results" class="sens-results">
    {% if sensitivity_results %}
    <img src="{{ url_for('static', filename=session['sensitivity_results']['plot_filename']) }}" alt="Sensitivity Analysis Plot">
    <form id="ai-assessment-form" method="post">
        <!-- AI Assessment Form Fields -->
        <input type="hidden" name="analysis_type" value="ai_sensitivity_assessment">
        <input type="hidden" name="sensitivity_results" value="{{ sensitivity_results }}">
        <div class="form-group full-width">
            <button type="button" onclick="submitForm('ai-assessment-form', '/exotic-options/barrier', 'gpt-assessment-section');">AI Assessment</button>
        </div>
    </form>
    {% endif %}
    </div>
    
    <div id="scenario-analysis" class="tab-content">
        <h4>Scenario Analysis</h4>
        <form id="scenario-form" onsubmit="return false;" class="form-grid">
            <input type="hidden" name="analysis_type" value="scenario">
            <input type="hidden" name="ticker" value="{{ form_data.ticker }}">
            <input type="hidden" name="K" value="{{ form_data.K }}">
            <input type="hidden" name="r" value="{{ form_data.r }}">
            <input type="hidden" name="sigma" value="{{ form_data.sigma }}">
            <input type="hidden" name="option_type" value="{{ form_data.option_type }}">
            <input type="hidden" name="start_date" value="{{ form_data.start_date }}">
            <input type="hidden" name="end_date" value="{{ form_data.end_date }}">
            <input type="hidden" name="q" value="{{ form_data.q }}">
            <input type="hidden" name="model" value="{{ form_data.model }}">
            <input type="hidden" name="N" value="{{ form_data.N }}">
            <input type="hidden" name="M" value="{{ form_data.M }}">
            <input type="hidden" name="barrier" value="{{ form_data.barrier }}">
            <input type="hidden" name="barrier_type" value="{{ form_data.barrier_type }}">
            <input type="hidden" name="discretization" value="{{ form_data.discretization }}">
            <div class="form-group">
                <label for="spot_scenario">Spot Price Scenario (% change):</label>
                <select id="spot_scenario" name="spot_scenario" required>
                    <option value="-0.25">-25%</option>
                    <option value="-0.10">-10%</option>
                    <option value="-0.05">-5%</option>
                    <option value="0">0%</option>
                    <option value="0.05">5%</option>
                    <option value="0.10">10%</option>
                    <option value="0.25">25%</option>
                </select>
            </div>
            <div class="form-group">
                <label for="vol_scenario">Volatility Scenario (abs change):</label>
                <select id="vol_scenario" name="vol_scenario" required>
                    <option value="-0.30">-30%</option>
                    <option value="-0.10">-10%</option>
                    <option value="-0.05">-5%</option>
                    <option value="0">0%</option>
                    <option value="0.05">5%</option>
                    <option value="0.10">10%</option>
                    <option value="0.30">30%</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rate_scenario">Interest Rate Scenario (abs change):</label>
                <select id="rate_scenario" name="rate_scenario" required>
                    <option value="-0.05">-5%</option>
                    <option value="-0.02">-2%</option>
                    <option value="-0.01">-1%</option>
                    <option value="0">0%</option>
                    <option value="0.01">1%</option>
                    <option value="0.02">2%</option>
                    <option value="0.05">5%</option>
                </select>
            </div>
            <div class="form-group full-width">
                <button type="button" onclick="submitForm('scenario-form', '/exotic-options/barrier', 'scenario-results');">Run Scenario Analysis</button>
            </div>
        </form>
        <!-- Scenario Analysis Results -->
        <div id="scenario-results" class="sens-results">
            {% if scenario_results %}
            <h4>Scenario Analysis Results</h4>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Scenarios</th>
                        <th>Option Price</th>
                        <th>Delta</th>
                        <th>Gamma</th>
                        <th>Vega</th>
                        <th>Theta</th>
                        <th>Rho</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Baseline</td>
                        <td>{{ session['scenario_results']['baseline_scenario_table']['baseline_price'] }}</td>
                        <td>{{ session['scenario_results']['baseline_scenario_table']['baseline_delta'] }}</td>
                        <td>{{ session['scenario_results']['baseline_scenario_table']['baseline_gamma'] }}</td>
                        <td>{{ session['scenario_results']['baseline_scenario_table']['baseline_vega'] }}</td>
                        <td>{{ session['scenario_results']['baseline_scenario_table']['baseline_theta'] }}</td>
                        <td>{{ session['scenario_results']['baseline_scenario_table']['baseline_rho'] }}</td>
                    </tr>
                    <tr>
                        <td>Stressed</td>
                        <td>{{ session['scenario_results']['stressed_scenario_table']['stressed_price'] }}</td>
                        <td>{{ session['scenario_results']['stressed_scenario_table']['stressed_delta'] }}</td>
                        <td>{{ session['scenario_results']['stressed_scenario_table']['stressed_gamma'] }}</td>
                        <td>{{ session['scenario_results']['stressed_scenario_table']['stressed_vega'] }}</td>
                        <td>{{ session['scenario_results']['stressed_scenario_table']['stressed_theta'] }}</td>
                        <td>{{ session['scenario_results']['stressed_scenario_table']['stressed_rho'] }}</td>
                    </tr>
                </tbody>
            </table>
            <form id="ai-scenario-assessment-form" method="post">
                <input type="hidden" name="analysis_type" value="ai_scenario_assessment">
                <div class="form-group full-width">
                    <button type="button" onclick="submitForm('ai-scenario-assessment-form', '/vanilla-options/model-performance', 'gpt-scenario-assessment-section');">AI Assessment</button>
                </div>
            </form>
            {% endif %}
        </div>
        <div id="gpt-scenario-assessment-section" class="gpt-results">
            {% if gpt_scenario_assessment %}
            <h4>MRM Assessment:</h4>
            <textarea id="gpt-scenario-assessment" class="assessment-textarea" readonly>{{ gpt_scenario_assessment }}</textarea>
            <button type="button" id="edit-scenario-assessment-btn" onclick="editAssessment('gpt-scenario-assessment');">Edit</button>
            <button type="button" id="save-scenario-assessment-btn" onclick="saveAssessment('gpt-scenario-assessment', '/vanilla-options/save-scenario-assessment');" style="display: inline;">Save</button>
            {% endif %}
        </div>
    </div>
    
    <div id="convergence-analysis" class="tab-content">
        <h4>Convergence Analysis</h4>
        
        <form id="convergence-form" method="post" class="form-grid">
            <input type="hidden" name="analysis_type" value="convergence">
            <input type="hidden" name="ticker" value="{{ form_data.ticker }}">
            <input type="hidden" name="K" value="{{ form_data.K }}">
            <input type="hidden" name="r" value="{{ form_data.r }}">
            <input type="hidden" name="sigma" value="{{ form_data.sigma }}">
            <input type="hidden" name="start_date" value="{{ form_data.start_date }}">
            <input type="hidden" name="end_date" value="{{ form_data.end_date }}">
            <input type="hidden" name="q" value="{{ form_data.q }}">
            <input type="hidden" name="N" value="{{ form_data.N }}">
            <input type="hidden" name="M" value="{{ form_data.M }}">
            <input type="hidden" name="barrier" value="{{ form_data.barrier }}">   
            <input type="hidden" name="option_type" value="{{ form_data.option_type }}">         
            <input type="hidden" name="barrier_type" value="{{ form_data.barrier_type }}">
            <input type="hidden" name="discretization" value="{{ form_data.discretization }}">
            
            <div class="form-group">
                <label for="mode">Mode:</label>
                <select id="mode" name="mode" required>
                    <option value="steps" {% if form_data.mode == 'steps' %}selected{% endif %}>Steps</option>
                    <option value="simulations" {% if form_data.mode == 'simulations' %}selected{% endif %}>Simulations</option>
                </select>
            </div>
                        
            <div class="form-group">
                <label for="max_steps"># of Time Steps (Maximum if Mode=Steps):</label>
                <input type="number" id="max_steps" name="max_steps" value="{{ form_data.max_steps }}" required>
            </div>
        
            <div class="form-group">
                <label for="max_sims"># of Simulations (Maximum if Mode=Simulations):</label>
                <input type="number" id="max_sims" name="max_sims" value="{{ form_data.max_sims }}" required>
            </div>
            
            <div class="form-group">
                <label for="obs">Observations:</label>
                <input type="number" id="obs" name="obs" value="{{ form_data.obs }}" required>
            </div>
            
            <div class="form-group full-width">
                <button type="submit" name="run_convergence_analysis" onclick="this.form.dataset.action='run_convergence_analysis';">Run Convergence Analysis</button>
            </div>
            
        </form>
        
        <div id="convergence-results" class="sens-results">
            {% if convergence_results %}
            <img src="{{ url_for('static', filename='barrier_convergence_plot.png') }}" alt="Convergence Analysis Plot">
            {% endif %}
        </div>
    </div>
    
    <div id="rbpl-analysis" class="tab-content">
        <h4>RBPL Analysis</h4>
        <form id="rbpl-form" method="post" class="form-grid">
            <input type="hidden" name="analysis_type" value="risk_pl">
            <input type="hidden" name="ticker" value="{{ form_data.ticker }}">
            <input type="hidden" name="K" value="{{ form_data.K }}">
            <input type="hidden" name="r" value="{{ form_data.r }}">
            <input type="hidden" name="sigma" value="{{ form_data.sigma }}">
            <input type="hidden" name="option_type" value="{{ form_data.option_type }}">
            <input type="hidden" name="start_date" value="{{ form_data.start_date }}">
            <input type="hidden" name="end_date" value="{{ form_data.end_date }}">
            <input type="hidden" name="q" value="{{ form_data.q }}">
            <input type="hidden" name="model" value="{{ form_data.model }}">
            <input type="hidden" name="N" value="{{ form_data.N }}">
            <input type="hidden" name="M" value="{{ form_data.M }}">
            <input type="hidden" name="barrier" value="{{ form_data.barrier }}">
            <input type="hidden" name="barrier_type" value="{{ form_data.barrier_type }}">
            <input type="hidden" name="discretization" value="{{ form_data.discretization }}">

            <div class="form-group">
                <label for="price_change">Bump in Spot Price:</label>
                <input type="number" step="0.01" id="price_change" name="price_change" value="{{ form_data.price_change }}" required>
            </div>
            <div class="form-group">
                <label for="vol_change">Bump in Volatility:</label>
                <input type="number" step="0.01" id="vol_change" name="vol_change" value="{{ form_data.vol_change }}" required>
            </div>
            <div class="form-group full-width">
                <button type="submit" name="run_risk_pl_analysis" onclick="this.form.dataset.action='run_risk_pl_analysis';">Run RBPL Analysis</button>
            </div>
        </form>
        {% if risk_pl_results %}
        <div id="rbpl-results">
            <div class="result">
            <h4>Results:</h4>
                <div class="horizontal-table">
                    <div class="table-row">
                        <div class="table-cell">Actual P&L</div>
                        <div class="table-cell">Greek P&L Sum</div>
                        <div class="table-cell">Difference</div>
                    </div>
                    <div class="table-row">
                        <div class="table-cell">{{ risk_pl_results['Actual P&L'] }}</div>
                        <div class="table-cell">{{ risk_pl_results['Greek P&L Sum'] }}</div>
                        <div class="table-cell">{{ risk_pl_results['Difference'] }}</div>
                    </div>
                    <br>
            <h4>Intermediate Calcuations:</h4>
                    <div class="table-row">
                        <div class="table-cell">Initial Price</div>
                        <div class="table-cell">Bumped Price</div>
                        <div class="table-cell">Delta P&L</div>
                        <div class="table-cell">Gamma P&L</div>
                        <div class="table-cell">Vega P&L</div>
                    </div>
                    <div class="table-row">
                        <div class="table-cell">{{ risk_pl_results['Initial Price'] }}</div>
                        <div class="table-cell">{{ risk_pl_results['Bumped Price'] }}</div>
                        <div class="table-cell">{{ risk_pl_results['Delta P&L'] }}</div>
                        <div class="table-cell">{{ risk_pl_results['Gamma P&L'] }}</div>
                        <div class="table-cell">{{ risk_pl_results['Vega P&L'] }}</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript for Form Submission and Loading Spinner -->
<script>
document.querySelectorAll('.form-grid, #options-form').forEach(form => {
    form.addEventListener('submit', function(event) {
        var loadingSpinner = document.getElementById('loadingSpinner');
        loadingSpinner.style.display = 'block';  // Show spinner on form submit

        // Hide spinner when form submission is complete
        this.addEventListener('load', function() {
            loadingSpinner.style.display = 'none';
        });
    });
});

// JavaScript for AJAX Form Submission
function submitForm(formId, url, updateId) {
    var form = document.getElementById(formId);
    var formData = new FormData(form);
    var xhr = new XMLHttpRequest();

    xhr.open("POST", url, true);

    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            console.log("Form submitted successfully");
            var parser = new DOMParser();
            var doc = parser.parseFromString(xhr.responseText, 'text/html');

            // Update the relevant section
            var updateSection = doc.getElementById(updateId);
            if (updateSection) {
                document.getElementById(updateId).innerHTML = updateSection.innerHTML;
                // Show the results section after successfully updating it
                document.getElementById(updateId).style.display = 'block';
            } else {
                console.log("Update section not found");
            }
        } else if (xhr.readyState === 4) {
            console.log("Error in form submission: " + xhr.status);
        }
    };

    xhr.onerror = function() {
        console.log("Request failed");
    };

    xhr.send(formData);
}

// JavaScript for Tabs
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;

    // Hide all tab contents
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Hide the sensitivity results
    const resultsSection = document.getElementById('sensitivity-results');
    resultsSection.style.display = "none";

    // Remove the active class from all tab buttons
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab content and add an active class to the button that opened the tab
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

// By default, open the first tab
document.addEventListener("DOMContentLoaded", function() {
    document.querySelector(".tab-button").click();
});
</script>

{% endblock %}
